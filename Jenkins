node {

	stage('GitHub-Checkout') {
		deleteDir() 
		cleanWs()
		checkout([$class: 'GitSCM', branches: [[name: '*/AltoroJ-3.2']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/tjitrak/AltoroJ.git']]])
	}
	
	stage('Gradle-Build') {
		sh '/var/lib/jenkins/tools/hudson.plugins.gradle.GradleInstallation/Gradle_6.8.3/bin/gradle build'
	}
	
	stage('Dependency Check Scan'){
		dependencyCheck additionalArguments: '--format ALL --disableAssembly', odcInstallation: 'dependency-check'
		dependencyCheckPublisher pattern: 'dependency-check-report.xml'
	}
	
	stage('Docker-Build'){
        sh 'docker stop altoroj-demo-app'
		sh 'docker rm altoroj-demo-app'
		sh 'docker rmi altoroj-demo-app'
        sh 'cp /var/lib/jenkins/workspace/xendit-demo/build/libs/home.war .'
        sh 'docker build -t altoroj-demo-app .'
    }

    stage('Deploy-App'){
        sh 'docker run -d --name altoroj-demo-app -p 80:8080 altoroj-demo-app'
    }
    
    stage('DAST-Scan-WebApp'){
        sh 'docker run --user root --rm -v $(pwd):/zap/wrk:rw -w /zap owasp/zap2docker-stable zap-full-scan.py -t https://owasp-juice.shop/ -r dast-zap-output.html -x ast-zap-output.xml -J ast-zap-output.json || true'
    }
    
    stage('DAST-Scan-API'){
        sh 'docker run --user root --rm -v $(pwd):/zap/wrk:rw -w /zap owasp/zap2docker-stable zap-api-scan.py -t http://demo.testfire.net/swagger/properties.json  -f openapi -r dast-api-zap-output.html -x ast-zap-output.xml -J ast-zap-output.json || true'
    }
}
